<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="com.sw.s1.board.notice.NoticeMapper">
    	<sql id="searcher">
    	<!-- 공통으로 사용하는 sql문 -->
    		<where>
				<choose>
				<when test="kind=='Writer'">
					writer like concat('%', #{search}, '%')
				</when>
				
				<when test="kind=='Contents'">
					contents like concat('%', #{search}, '%')
				</when>
				
				<otherwise>
					title like concat('%', #{search}, '%')
				</otherwise>
				</choose>
			</where>
    	</sql>
    
    	<select id="getList" resultType="NoticeVO" parameterType="Pager">
			select * from notice 
			<include refid="searcher"></include>
			order by num desc
			limit #{startRow}, #{perPage}
			<!-- limit 시작index번호(0부터시작), 갯수 -->
    	</select>
    	
    	<select id="getTotalCount" resultType="Long" parameterType="Pager">
			select count(num) from notice
			<include refid="searcher"></include>
		</select>
    	
    	<select id="getSelect" parameterType="BoardVO" resultMap="selectResult">
			SELECT N.*, NF.* 
			FROM notice N LEFT JOIN noticeFiles NF
			ON N.num = NF.num
			WHERE N.num=#{num}
    	</select>
    	
    	<resultMap type="NoticeVO" id="selectResult">
    		<id property="num" column="num"/>
    		<result property="title" column="title"/>
    		<result property="writer" column="writer"/>
    		<result property="contents" column="contents"/>
    		<result property="regDate" column="regDate"/>
    		<result property="hit" column="hit"/>
    		<collection property="files" javaType="java.util.List" ofType="BoardFileVO">
	    		<id property="fileNum" column="filenum"/>
	    		<result property="fileName" column="filename"/>
	    		<result property="oriName" column="oriname"/>	
    		</collection>
    	</resultMap>
   
    	
    	<update id="setHitUpdate" parameterType="BoardVO">
    		update notice set hit=hit+1 where num=#{num}
    	</update>
    	
    	<!--insert하기 전에 AutoIncreament로 증가된 값을 먼저 받아서 BoardVO num에 넣겠다 -->
    	<insert id="setInsert" parameterType="BoardVO" useGeneratedKeys="true" keyProperty="num">
    		insert into notice values (#{num}, #{title}, #{writer}, #{contents}, now(), 0)
    	</insert>
    	
    	<insert id="setFileInsert" parameterType="BoardFileVO">
    		insert into noticeFiles (num, filename, oriname) 
    		values (#{num}, #{fileName}, #{oriName})
    	</insert>
    	
    	<update id="setUpdate" parameterType="BoardVO">
    		update notice set title=#{title}, contents=#{contents} where num=#{num}
    	</update>
    	
		<delete id="setDelete" parameterType="BoardVO">
			delete from notice where num=#{num}
		</delete>
		

    
    </mapper>